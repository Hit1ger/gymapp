<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>История тренировок</title>
    <link rel="stylesheet" href="style.css">
    <style>
#increaseWeight, #decreaseWeight, #increaseReps, #decreaseReps {
margin-bottom: 7px;
    margin-top: 3px;
    height: 41.6px;
}
        
        /* Стили для истории тренировок */
        .history-item {
            display: flex;
            flex-direction: row;
            border-bottom: 1px solid #ccc;
            padding: 10px 15px;
            cursor: pointer;
        }

        /* При раскрытии устанавливаем flex-direction: column */
        .history-item.open {
            flex-direction: column;
        }

        .history-name {
            font-size: 17px;
            color: black;
        }

        .history-datetime {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }

        .history-datetime,
        .history-duration {
            font-size: 14px;
            color: #666;
        }

        .history-details {
            display: none;
        }

        /* Стили для текста дыхательного цикла под таймером */
        #breathText {
            text-align: center;
            font-size: 24px;
            color: #fff;
            margin-top: 10px;
        }

        #historyList {
            margin-top: 15px;
        }
    </style>
</head>

<body>

<header class="site-header">
  <!-- Логотип / Название -->
  <div class="site-header__logo">
   История тренировок
  </div>

  <!-- Кнопка-гамбургер (когда ширина экрана маленькая) -->
  <button class="hamburger" id="hamburgerBtn" aria-label="Открыть меню">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>

  <!-- Основная навигация (для десктопа и мобильного) -->
  <nav class="site-nav" id="mobileNav">
    <ul>
      <li><a href="index.html">Главная</a></li>
      <li><a href="workout-list.html">Тренировки</a></li>
      <li><a href="current-workout.html">Старт</a></li>
      <li><a href="base.html">База</a></li>
      <li><a href="analytics.html">Анализ</a></li>
        <li><a href="files.html">Файлы</a></li>
      <!-- Добавьте свои пункты меню -->
    </ul>
  </nav>
</header>

    <input type="file" id="uploadHistoryInput" accept=".json" style="display: none;">

    <div>
        <button id="startWorkout">Начать тренировку</button>
    </div>

    <div id="historyList"></div>

    <!-- Модальные окна для тренировок и упражнений оставляем без изменений -->
    <div id="workoutModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <span>Выберите тренировку</span>
                <span class="close" onclick="closeModal('workoutModal')">&times;</span>
            </div>
            <div id="workoutList"></div>
        </div>
    </div>

    <div id="exerciseModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <span id="workoutTitle"></span>
                <span class="close" onclick="closeModal('exerciseModal')">&times;</span>
            </div>
            <div id="exerciseContainer"></div>
            <button id="addSetButton" class="full-width-btn">Подход</button>
            <div id="setCounter" class="set-counter">
                <span>Подходы:</span>
                <span id="setCount">0</span>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="prevExercise" style="flex: 1; display: none;">Назад</button>
                <button id="nextExercise" style="flex: 1;">Следующее упражнение</button>
            </div>
            <button id="saveProgress" style="margin-top: 10px; width: 100%;">Сохранить</button>
        </div>
    </div>

    <!-- Обновлённый оверлей для таймера с дополнительным элементом для дыхательного текста -->
    <div id="overlay" style="flex-direction: column;">
        <div id="timer"></div>
        <div id="breathText"></div>
    </div>

    <footer>
        <nav class="footer-nav">
            <a href="index.html" class="footer-link">Главная</a>
            <a href="workout-list.html" class="footer-link">Тренинг</a>
            <a href="current-workout.html" class="footer-link active">Старт</a>
            <a href="base.html" class="footer-link">База</a>
            <a href="analytics.html" class="footer-link">Анализ</a>       
        </nav>
    </footer>

    <script>
        let currentRest = 90;
        let workouts = [];
        let history = JSON.parse(localStorage.getItem("history")) || [];
        let currentWorkout = null;
        let currentExerciseIndex = 0;
        let setCount = 0;
        let exerciseSets = [];

        document.addEventListener("DOMContentLoaded", () => {
            workouts = JSON.parse(localStorage.getItem("workouts")) || [];
            console.log("Тренировки при загрузке страницы:", workouts);
            loadHistory();
        });

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        document.getElementById("startWorkout").addEventListener("click", () => {
            loadWorkouts();
            document.getElementById("workoutModal").style.display = "flex";
        });

        function loadHistory() {
            const historyList = document.getElementById("historyList");
            if (!historyList) return;
            historyList.innerHTML = history.map((h, index) =>
                `<div class="history-item" onclick="toggleHistoryDetails(this, ${index})">
            <div>
              <div class="history-name">${h.name}</div>
              <div class="history-datetime">${h.date} ${h.time}</div>
            </div>
            <div class="history-duration">${h.duration || "0 мин 0 сек"}</div>
            <div class="history-details"></div>
          </div>`
            ).join("");
        }

        function toggleHistoryDetails(itemElement, index) {
            const detailsElement = itemElement.querySelector('.history-details');
            if (detailsElement.style.display === "none" || detailsElement.style.display === "") {
                const h = history[index];
                let details = ``;
                h.exercises.forEach(exercise => {
                    details += `<p style="margin-bottom: 6px; font-size: 16px; letter-spacing: 0; line-height: 1; color: #000000;">${exercise.name}</p>`;
                    exercise.setsDetails.forEach((set, i) => {
                        details += `<span style="display: block; color: #666; font-size: 14px; margin-bottom: 3px;">Подход ${i + 1}: Вес - ${set.weight} кг, Повторения - ${set.reps}</span>`;
                    });
                });
                // Вставляем кнопку удаления тренировки:
                details += `<button style="margin-top: 10px; padding: 5px 10px;" onclick="deleteWorkout(${index}, event)">Удалить тренировку</button>`;
                detailsElement.innerHTML = details;
                detailsElement.style.display = "block";
                itemElement.classList.add("open");
            } else {
                detailsElement.style.display = "none";
                itemElement.classList.remove("open");
            }
        }

        function deleteWorkout(index, event) {
            event.stopPropagation();
            if (confirm("Вы действительно хотите удалить тренировку?")) {
                history.splice(index, 1);
                localStorage.setItem("history", JSON.stringify(history));
                loadHistory();
            }
        }

        function loadWorkouts() {
            workouts = JSON.parse(localStorage.getItem("workouts")) || [];
            console.log("Загруженные тренировки:", workouts);
            const workoutList = document.getElementById("workoutList");
            workoutList.innerHTML = "";

            if (workouts.length === 0) {
                workoutList.innerHTML = "<span>Нет сохраненных тренировок</span>";
                return;
            }

            workouts.forEach((workout, index) => {
                const div = document.createElement("div");
                div.classList.add("workout-item");
                div.textContent = workout.name;
                div.addEventListener("click", () => startWorkout(index));
                workoutList.appendChild(div);
            });
        }

        function startWorkout(index) {
            currentWorkout = workouts[index];
            currentWorkout.startTime = null;
            currentExerciseIndex = 0;
            currentWorkout.exercises.forEach(e => e.setsDetails = []);
            document.getElementById("workoutTitle").textContent = currentWorkout.name;
            loadExercise();
            closeModal("workoutModal");
            document.getElementById("exerciseModal").style.display = "flex";
        }

        function loadExercise() {
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            setCount = exercise.setsDetails.length;
            document.getElementById("setCount").textContent = setCount;
            const exerciseContainer = document.getElementById("exerciseContainer");

            exerciseContainer.innerHTML = `
                <p><strong>Упражнение:</strong> ${exercise.name}</p>

                <label>Повторений:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button type="button" id="decreaseReps">−</button>
                    <input type="number" id="reps" value="${exercise.reps}" style="text-align: center; width: 120px;">
                    <button type="button" id="increaseReps">+</button>
                </div>

                <label>Вес (кг):</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button type="button" id="decreaseWeight">−</button>
                    <input type="number" id="weight" value="${exercise.weight}" step="0.5" style="text-align: center; width: 120px;">
                    <button type="button" id="increaseWeight">+</button>
                </div>
            `;
            currentRest = exercise.rest || 30;
            addExerciseControls();
            updateNavigationButtons();
        }

        document.getElementById("addSetButton").addEventListener("click", () => {
            if (!currentWorkout.startTime) {
                currentWorkout.startTime = Date.now();
            }
            const reps = document.getElementById("reps").value;
            const weight = document.getElementById("weight").value;
            currentWorkout.exercises[currentExerciseIndex].setsDetails.push({
                reps,
                weight
            });
            setCount = currentWorkout.exercises[currentExerciseIndex].setsDetails.length;
            document.getElementById("setCount").textContent = setCount;

            startTimer(currentRest);
        });

        function startTimer(seconds) {
            const timerElement = document.getElementById("timer");
            const breathTextElement = document.getElementById("breathText");
            const overlay = document.getElementById("overlay");
            overlay.style.display = "flex";

            // Задаём фазы дыхательного цикла и их длительность в секундах
            const phases = [{
                    text: "Вдох",
                    duration: 3
                },
                {
                    text: "Пауза",
                    duration: 2
                },
                {
                    text: "Выдох",
                    duration: 5
                },
                {
                    text: "Пауза",
                    duration: 2
                }
            ];
            const totalCycle = phases.reduce((sum, phase) => sum + phase.duration, 0);
            let elapsedCycle = 0; // время, прошедшее с начала таймера

            let remaining = seconds;
            timerElement.textContent = `${remaining}`;

            // Интервал обновления каждую секунду
            const interval = setInterval(() => {
                remaining--;
                elapsedCycle++;

                // Обновляем цифру обратного отсчёта
                if (remaining > 0) {
                    timerElement.textContent = `${remaining}`;
                } else {
                    clearInterval(interval);
                    timerElement.textContent = "GO!";
                    breathTextElement.textContent = "";
                    overlay.style.display = "none";
                    return;
                }

                // Рассчитываем текущую фазу дыхательного цикла (циклично)
                const currentPhaseTime = elapsedCycle % totalCycle;
                let phaseStart = 0;
                for (let i = 0; i < phases.length; i++) {
                    if (currentPhaseTime < phaseStart + phases[i].duration) {
                        breathTextElement.textContent = phases[i].text;
                        break;
                    }
                    phaseStart += phases[i].duration;
                }
            }, 1000);
        }

        document.getElementById("nextExercise").addEventListener("click", () => {
            // Обновляем вес и повторения текущего упражнения из полей ввода
            const newWeight = parseFloat(document.getElementById("weight").value);
            const newReps = parseInt(document.getElementById("reps").value);
            currentWorkout.exercises[currentExerciseIndex].weight = newWeight;
            currentWorkout.exercises[currentExerciseIndex].reps = newReps;

            // Обновляем глобальный массив workouts для сохранения изменённых значений
            workouts = workouts.map(workout => {
                if (workout.name === currentWorkout.name) {
                    return currentWorkout;
                }
                return workout;
            });
            localStorage.setItem("workouts", JSON.stringify(workouts));

            if (currentExerciseIndex < currentWorkout.exercises.length - 1) {
                currentExerciseIndex++;
                loadExercise();
            } else {
                saveWorkoutHistory();
                closeModal("exerciseModal");
            }
        });

        document.getElementById("prevExercise").addEventListener("click", () => {
            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
                loadExercise();
            }
        });

        document.getElementById("saveProgress").addEventListener("click", () => {
            // Обновляем вес и повторения текущего упражнения из полей ввода
            const newWeight = parseFloat(document.getElementById("weight").value);
            const newReps = parseInt(document.getElementById("reps").value);
            currentWorkout.exercises[currentExerciseIndex].weight = newWeight;
            currentWorkout.exercises[currentExerciseIndex].reps = newReps;

            // Обновляем глобальный массив workouts для сохранения изменённых значений
            workouts = workouts.map(workout => {
                if (workout.name === currentWorkout.name) {
                    return currentWorkout;
                }
                return workout;
            });
            localStorage.setItem("workouts", JSON.stringify(workouts));

            saveWorkoutHistory();
            alert("Тренировка сохранена!");
            closeModal("exerciseModal");
        });

        function saveWorkoutHistory() {
            const now = new Date();
            let durationFormatted = "0 мин 0 сек";
            if (currentWorkout.startTime) {
                const duration = now.getTime() - currentWorkout.startTime;
                const durationMinutes = Math.floor(duration / 60000);
                const durationSeconds = Math.floor((duration % 60000) / 1000);
                durationFormatted = `${durationMinutes} мин ${durationSeconds} сек`;
            }
            let exercisesData = JSON.parse(localStorage.getItem("exercises")) || [];

            history.push({
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString(),
                name: currentWorkout.name,
                duration: durationFormatted,
                exercises: currentWorkout.exercises.map(e => {
                    let exerciseInfo = exercisesData.find(item =>
                        item.title.toLowerCase().trim() === e.name.toLowerCase().trim()
                    );
                    return {
                        name: e.name,
                        muscle_group: exerciseInfo ? exerciseInfo.muscle_group : null,
                        setsDetails: e.setsDetails
                    };
                })
            });
            localStorage.setItem("history", JSON.stringify(history));
            loadHistory();
        }

        function updateNavigationButtons() {
            const prevButton = document.getElementById("prevExercise");
            const nextButton = document.getElementById("nextExercise");
            prevButton.style.display = currentExerciseIndex > 0 ? "block" : "none";
            if (currentExerciseIndex >= currentWorkout.exercises.length - 1) {
                nextButton.style.display = "none";
                prevButton.style.flex = "1 1 100%";
            } else {
                nextButton.style.display = "block";
                prevButton.style.flex = "1";
            }
        }

        function addExerciseControls() {
            document.getElementById("increaseReps").addEventListener("click", () => {
                const repsInput = document.getElementById("reps");
                repsInput.value = parseInt(repsInput.value) + 1;
            });

            document.getElementById("decreaseReps").addEventListener("click", () => {
                const repsInput = document.getElementById("reps");
                repsInput.value = Math.max(0, parseInt(repsInput.value) - 1);
            });

            document.getElementById("increaseWeight").addEventListener("click", () => {
                const weightInput = document.getElementById("weight");
                weightInput.value = (parseFloat(weightInput.value) + 0.5).toFixed(1);
            });

            document.getElementById("decreaseWeight").addEventListener("click", () => {
                const weightInput = document.getElementById("weight");
                weightInput.value = Math.max(0, parseFloat(weightInput.value) - 0.5).toFixed(1);
            });
        }

        // Функция для скачивания данных из localStorage в виде JSON-файла
        function downloadData(key, filename) {
            const data = localStorage.getItem(key) || "[]";
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
            const downloadAnchor = document.createElement("a");
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", filename);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);
        }

        // Функция обработки загрузки файла и сохранения данных в localStorage
        function uploadData(event, key) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    // Проверяем тип данных по необходимости, здесь просто сохраняем
                    localStorage.setItem(key, JSON.stringify(loadedData));
                    alert("JSON загружен успешно");
                    // При необходимости можно перезагрузить страницу или обновить отображение
                } catch (error) {
                    alert("Ошибка загрузки файла! Убедитесь, что это корректный JSON.");
                }
            };
            reader.readAsText(file);
        }



        // Обработчики для секции История тренировок (ключ "history")
        document.getElementById("downloadWorkoutHistoryJSON").addEventListener("click", () => {
            downloadData("history", "history.json");

        });
        document.getElementById("uploadWorkoutHistoryJSON").addEventListener("click", () => {
            document.getElementById("uploadHistoryInput").click();
        });
        document.getElementById("uploadHistoryInput").addEventListener("change", (e) => {
            uploadData(e, "history");
        });
    </script>

<script>
  // Находим кнопку и блок меню:
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const mobileNav = document.getElementById('mobileNav');

  hamburgerBtn.addEventListener('click', () => {
    // Переключаем класс .show на nav
    mobileNav.classList.toggle('show');
  });
</script>
    
</body>

</html>
